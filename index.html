<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MineraLink ‚Äì Wells & Parcels Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.vectorgrid/dist/Leaflet.VectorGrid.bundled.js"></script>

<style>
  html,body,#map {height:100%;margin:0;padding:0;}
  .leaflet-control-layers-expanded {font-size:14px;}
  .popup-table {border-collapse:collapse;width:100%;font-size:13px;}
  .popup-table td {border-bottom:1px solid #ddd;padding:2px 4px;vertical-align:top;}
  .toast {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #222;
    color: #fff;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 13px;
    z-index: 9999;
    opacity: 0.9;
  }
</style>
</head>
<body>
<div id="map"></div>
<script>
function showToast(msg) {
  const div = document.createElement("div");
  div.className = "toast";
  div.innerText = msg;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 3500);
}

// --- Base layers ---
const esriSat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Tiles ¬© Esri, Maxar, Earthstar Geographics" }
);
const esriLabels = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Labels ¬© Esri" }
);
const hybrid = L.layerGroup([esriSat, esriLabels]);
const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬© OpenStreetMap" });

const map = L.map("map", { center: [39, -80], zoom: 7, layers: [hybrid] });
const WV_BOUNDS = [[37.046230, -82.362192], [40.501588, -79.234826]];
map.fitBounds(WV_BOUNDS);

// --- Datasets to load ---
const tileFolders = ["WV_wells"];
const colors = { WV_wells: "#ff6600" };

// --- Build popup ---
function buildPopupHTML(folder, props) {
  let html = `<b>${folder}</b><table class='popup-table'>`;
  for (const [k,v] of Object.entries(props)) html += `<tr><td>${k}</td><td>${v}</td></tr>`;
  html += "</table>";
  return html;
}

// --- Try to load a folder (tiles or fallback) ---
async function loadLayer(folder) {
  const color = colors[folder] || "#3388ff";

  // Try both possible tile paths
  const paths = [
    `${folder}/metadata.json`,
    `tiles/${folder}/metadata.json`
  ];

  let meta = null, urlPrefix = null;
  for (const path of paths) {
    try {
      const res = await fetch(path);
      if (res.ok) {
        meta = await res.json();
        urlPrefix = path.replace("/metadata.json", "");
        break;
      }
    } catch {}
  }

  // If vector tiles exist
  if (meta && meta.vector_layers?.[0]) {
    const id = meta.vector_layers[0].id;
    const layer = L.vectorGrid.protobuf(
      `${urlPrefix}/{z}/{x}/{y}.pbf`,
      {
        vectorTileLayerStyles: {
          [id]: {
            radius: 3,
            color: color,
            weight: 0,
            fill: true,
            fillColor: color,
            fillOpacity: 0.7
          }
        },
        interactive: true,
        maxNativeZoom: 14,
        maxZoom: 19
      }
    );
    layer.on("click", e => {
      const props = e.layer.properties || {};
      L.popup().setLatLng(e.latlng).setContent(buildPopupHTML(folder, props)).openOn(map);
    });
    console.log(`‚úÖ Loaded vector tiles for ${folder}`);
    showToast(`Loaded tiles: ${folder}`);
    return [folder, layer];
  }

  // Else try fallback GeoJSON
  try {
    const fallbackRes = await fetch(`fallback_data/${folder}.geojson`);
    if (fallbackRes.ok) {
      const data = await fallbackRes.json();
      const layer = L.geoJSON(data, {
        pointToLayer: (f, latlng) => L.circleMarker(latlng, {
          radius: 3,
          color: color,
          fillColor: color,
          fillOpacity: 0.7
        })
      }).bindPopup(l => buildPopupHTML(folder, l.feature.properties));
      console.log(`üß© Using fallback for ${folder}`);
      showToast(`Using fallback: ${folder}`);
      return [folder, layer];
    }
  } catch {}

  console.warn(`‚ö†Ô∏è No data for ${folder}`);
  showToast(`‚ö†Ô∏è No data for ${folder}`);
  return null;
}

// --- Initialize map ---
(async function init() {
  const overlays = {};
  for (const f of tileFolders) {
    const result = await loadLayer(f);
    if (result) {
      const [name, layer] = result;
      overlays[name] = layer;
      layer.addTo(map);
    }
  }
  L.control.layers({ "Satellite + Labels": hybrid, "OpenStreetMap": osm }, overlays, { collapsed:false }).addTo(map);
})();
</script>
</body>
</html>
