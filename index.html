<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MineraLink – Auto Layer Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.vectorgrid/dist/Leaflet.VectorGrid.bundled.js"></script>
<style>
  html,body,#map{height:100%;margin:0;padding:0}
  .leaflet-control-layers-expanded{font-size:14px}
</style>
</head>
<body>
<div id="map"></div>

<script>
const map = L.map("map", {
  center: [39.0, -80.0],
  zoom: 7
});

// --- Base layers ---
const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "© OpenStreetMap contributors"
});
const esriSat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Tiles © Esri — Sources: Esri, Maxar, Earthstar Geographics" }
);
const esriLabels = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Labels © Esri" }
);
const hybrid = L.layerGroup([esriSat, esriLabels]);
hybrid.addTo(map);

// --- Define folders ---
const tileFolders = [
  "WV_wells",
  "WV_parcels",
  "PA_wells",
  "PA_parcels",
  "PA_laterals",
  "OH_parcels"
];

// --- Color palette for auto styling ---
const colors = {
  WV_wells: "#ff6600",
  WV_parcels: "#33cc33",
  PA_wells: "#ffcc00",
  PA_parcels: "#00ffff",
  PA_laterals: "#9900ff",
  OH_parcels: "#ff0099"
};

// --- Function to build each layer automatically ---
async function loadVectorLayer(folder) {
  try {
    const response = await fetch(`tiles/${folder}/metadata.json`);
    const metadata = await response.json();
    const id = metadata.vector_layers[0].id; // auto-detect id
    const color = colors[folder] || "#3388ff";

    const layer = L.vectorGrid.protobuf(`tiles/${folder}/{z}/{x}/{y}.pbf`, {
      vectorTileLayerStyles: {
        [id]: {
          color: color,
          weight: 1,
          fill: true,
          fillColor: color,
          fillOpacity: 0.4
        }
      },
      interactive: true,
      maxNativeZoom: 14,
      maxZoom: 19
    });

    layer.on("click", e => {
      const props = e.layer.properties || {};
      let html = `<b>${folder}</b><br>`;
      for (const key in props) html += `<b>${key}</b>: ${props[key]}<br>`;
      L.popup().setLatLng(e.latlng).setContent(html).openOn(map);
    });

    return [folder, layer];
  } catch (err) {
    console.warn(`Could not load ${folder}:`, err);
    return null;
  }
}

// --- Build and add layer control ---
(async function init() {
  const overlayLayers = {};
  for (const f of tileFolders) {
    const result = await loadVectorLayer(f);
    if (result) {
      const [name, layer] = result;
      overlayLayers[name] = layer;
      if (name.startsWith("WV_")) layer.addTo(map); // turn on WV by default
    }
  }
  L.control.layers(
    { "Satellite + Labels": hybrid, "OpenStreetMap": osm },
    overlayLayers,
    { collapsed: false }
  ).addTo(map);
})();
</script>
</body>
</html>
